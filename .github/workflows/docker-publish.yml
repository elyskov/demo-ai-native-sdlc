name: Docker Publish

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag to publish (defaults to git tag vX.Y.Z on HEAD, else 'mvp')."
        required: false
        default: ""

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure main branch
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF}" != "refs/heads/main" ]]; then
            echo "This workflow only publishes images from the main branch. Current ref: ${GITHUB_REF}" >&2
            exit 1
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute version
        id: version
        shell: bash
        env:
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail

          VERSION=""

          # Prefer explicit workflow_dispatch input when provided.
          if [[ -n "${INPUT_VERSION}" ]]; then
            VERSION="${INPUT_VERSION}"
          else
            TAG=$(git tag --points-at "${GITHUB_SHA}" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+([-.].*)?$' | head -n 1 || true)
            if [[ -n "${TAG}" ]]; then
              VERSION="${TAG}"
            else
              VERSION="mvp"
            fi
          fi

          echo "Resolved version: ${VERSION}"
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"

      - name: Build & push backend image
        uses: docker/build-push-action@v6
        with:
          context: services/backend
          file: services/backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPOSITORY }}:backend-${{ steps.version.outputs.version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPOSITORY }}:backend-latest
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

      - name: Build & push frontend image
        uses: docker/build-push-action@v6
        with:
          context: services/frontend
          file: services/frontend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPOSITORY }}:frontend-${{ steps.version.outputs.version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPOSITORY }}:frontend-latest
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend
