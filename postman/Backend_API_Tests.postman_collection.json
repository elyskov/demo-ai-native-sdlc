{
  "info": {
    "name": "Backend API Tests",
    "description": "Comprehensive API tests for the demo-ai-native-sdlc backend service (NestJS). Tests are ordered for sequential execution with request chaining via collection variables.\n\nRequires: Backend service running on {{backend_base_url}} (default http://localhost:3000).",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "event": [
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "pm.test('Response time is acceptable', function () {",
          "    pm.expect(pm.response.responseTime).to.be.below(5000);",
          "});"
        ]
      }
    }
  ],
  "variable": [
    { "key": "diagram_id", "value": "", "description": "Auto-set by Create Diagram test" },
    { "key": "crud_diagram_id", "value": "", "description": "Auto-set for CRUD test cleanup" },
    { "key": "entity_id", "value": "", "description": "Auto-set by Create Entity (region) test" },
    { "key": "child_entity_id", "value": "", "description": "Auto-set by Create Child Entity (site) test" },
    { "key": "def_manufacturer_id", "value": "", "description": "Auto-set by Create Entity (manufacturer) test" },
    { "key": "def_device_role_id", "value": "", "description": "Auto-set by Create Entity (device-role) test" }
  ],
  "item": [
    {
      "name": "Health",
      "description": "Health check endpoints for liveness verification",
      "item": [
        {
          "name": "Health Check (root)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{backend_base_url}}/health",
              "host": ["{{backend_base_url}}"],
              "path": ["health"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has required health fields', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('name');",
                  "    pm.expect(body).to.have.property('environment');",
                  "    pm.expect(body).to.have.property('nestVersion');",
                  "    pm.expect(body).to.have.property('nodeVersion');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Health Check (API)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{backend_base_url}}/api/health",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "health"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has required health fields', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('name');",
                  "    pm.expect(body).to.have.property('environment');",
                  "    pm.expect(body).to.have.property('nestVersion');",
                  "    pm.expect(body).to.have.property('nodeVersion');",
                  "    pm.expect(body.nodeVersion).to.match(/^v\\d+/);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Diagrams CRUD",
      "description": "Diagram create, read, update, delete operations with validation tests",
      "item": [
        {
          "name": "List Diagrams",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response is an array of diagram metadata', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.be.an('array');",
                  "    if (body.length > 0) {",
                  "        pm.expect(body[0]).to.have.property('id');",
                  "        pm.expect(body[0]).to.have.property('name');",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Diagram",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"name\": \"Postman CRUD Test Diagram\"}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Response contains created diagram', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('id');",
                  "    pm.expect(body).to.have.property('name', 'Postman CRUD Test Diagram');",
                  "    pm.expect(body).to.have.property('content');",
                  "    pm.expect(body.id).to.match(/^[0-9a-zA-Z_]{16}$/);",
                  "",
                  "    pm.collectionVariables.set('crud_diagram_id', body.id);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get Diagram",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{crud_diagram_id}}",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{crud_diagram_id}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response matches created diagram', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.id).to.eql(pm.collectionVariables.get('crud_diagram_id'));",
                  "    pm.expect(body).to.have.property('name');",
                  "    pm.expect(body).to.have.property('content');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Rename Diagram (PATCH)",
          "request": {
            "method": "PATCH",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"name\": \"Renamed Test Diagram\"}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{crud_diagram_id}}",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{crud_diagram_id}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Name is updated', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.name).to.eql('Renamed Test Diagram');",
                  "    pm.expect(body.id).to.eql(pm.collectionVariables.get('crud_diagram_id'));",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Update Diagram (PUT)",
          "request": {
            "method": "PUT",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"name\": \"Updated Test Diagram\", \"content\": \"C4Deployment\\n    title Updated Test Diagram\\n\"}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{crud_diagram_id}}",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{crud_diagram_id}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Both name and content are updated', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.name).to.eql('Updated Test Diagram');",
                  "    pm.expect(body.content).to.include('Updated Test Diagram');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Delete CRUD Test Diagram",
          "request": {
            "method": "DELETE",
            "header": [],
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{crud_diagram_id}}",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{crud_diagram_id}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Deleted diagram ID matches', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('id', pm.collectionVariables.get('crud_diagram_id'));",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Verify CRUD Diagram Deleted (404)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{crud_diagram_id}}",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{crud_diagram_id}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Diagram no longer exists', function () {",
                  "    pm.response.to.have.status(404);",
                  "});",
                  "",
                  "pm.collectionVariables.set('crud_diagram_id', '');"
                ]
              }
            }
          ]
        },
        {
          "name": "Get Diagram - Invalid ID (400)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/bad!",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "bad!"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 400 for invalid ID format', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Error response has expected shape', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('statusCode', 400);",
                  "    pm.expect(body).to.have.property('message');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get Diagram - Not Found (404)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/aaaaaaaaaaaaaaaa",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "aaaaaaaaaaaaaaaa"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 404 for non-existent diagram', function () {",
                  "    pm.response.to.have.status(404);",
                  "});",
                  "",
                  "pm.test('Error response has expected shape', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('statusCode', 404);",
                  "    pm.expect(body).to.have.property('message');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Diagram - Validation Error (400)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 400 for empty body', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Validation error mentions name field', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('statusCode', 400);",
                  "    const msg = JSON.stringify(body.message).toLowerCase();",
                  "    pm.expect(msg).to.include('name');",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Diagram Commands",
      "description": "Command endpoint tests: list-types, create, get-element, update, list-elements, move, delete entities. Uses a fresh diagram with intact Mermaid template.",
      "item": [
        {
          "name": "Create Diagram for Commands",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"name\": \"Postman Commands Test\"}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Diagram created for command tests', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('id');",
                  "    pm.expect(body).to.have.property('content');",
                  "    pm.collectionVariables.set('diagram_id', body.id);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "List Types (infrastructure root)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"list-types\", \"entity\": \"infrastructure\", \"parent\": {\"root\": \"infrastructure\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Response has types and details', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('types');",
                  "    pm.expect(body.types).to.be.an('array');",
                  "    pm.expect(body.types.length).to.be.above(0);",
                  "    pm.expect(body).to.have.property('details');",
                  "    const first = body.types[0];",
                  "    pm.expect(body.details).to.have.property(first);",
                  "    pm.expect(body.details[first]).to.have.property('attributeDefinitions');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "List Types (definitions root)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"list-types\", \"entity\": \"definitions\", \"parent\": {\"root\": \"definitions\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Response has definition types', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('types');",
                  "    pm.expect(body.types).to.be.an('array');",
                  "    pm.expect(body.types.length).to.be.above(0);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Entity (device-role)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"create\", \"entity\": \"device-role\", \"parent\": {\"root\": \"definitions\"}, \"attributes\": {\"name\": \"Switch\", \"slug\": \"switch\", \"color\": \"445566\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Diagram includes new device-role', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.content).to.include('device-role: Switch');",
                  "    pm.expect(body.content).to.include('device_role_');",
                  "    const match = String(body.content || '').match(/device_role_([A-Za-z0-9]+)/);",
                  "    pm.expect(match, 'Expected device_role_<id> in content').to.not.be.null;",
                  "    pm.collectionVariables.set('def_device_role_id', match[1]);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Entity (manufacturer)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"create\", \"entity\": \"manufacturer\", \"parent\": {\"root\": \"definitions\"}, \"attributes\": {\"name\": \"Acme\", \"slug\": \"acme\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Diagram includes new manufacturer', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.content).to.include('manufacturer: Acme');",
                  "    pm.expect(body.content).to.include('manufacturer_');",
                  "    const match = String(body.content || '').match(/manufacturer_([A-Za-z0-9]+)/);",
                  "    pm.expect(match, 'Expected manufacturer_<id> in content').to.not.be.null;",
                  "    pm.collectionVariables.set('def_manufacturer_id', match[1]);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get Element (device-role) (definitions context)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"get-element\", \"entity\": \"device-role\", \"id\": \"{{def_device_role_id}}\"}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Device-role context is correct', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('entity', 'device-role');",
                  "    pm.expect(body).to.have.property('id', pm.collectionVariables.get('def_device_role_id'));",
                  "    pm.expect(body).to.have.property('attributes');",
                  "    pm.expect(body.attributes).to.have.property('name', 'Switch');",
                  "    pm.expect(body.attributes).to.have.property('slug', 'switch');",
                  "    pm.expect(body.attributes).to.have.property('color', '445566');",
                  "    pm.expect(body).to.have.property('parent');",
                  "    pm.expect(body.parent).to.have.property('root', 'definitions');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get Element (manufacturer) (definitions context)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"get-element\", \"entity\": \"manufacturer\", \"id\": \"{{def_manufacturer_id}}\"}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Manufacturer context is correct', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('entity', 'manufacturer');",
                  "    pm.expect(body).to.have.property('id', pm.collectionVariables.get('def_manufacturer_id'));",
                  "    pm.expect(body).to.have.property('attributes');",
                  "    pm.expect(body.attributes).to.have.property('name', 'Acme');",
                  "    pm.expect(body.attributes).to.have.property('slug', 'acme');",
                  "    pm.expect(body).to.have.property('parent');",
                  "    pm.expect(body.parent).to.have.property('root', 'definitions');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Entity (rack-type) missing width (400)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"create\", \"entity\": \"rack-type\", \"parent\": {\"entity\": \"manufacturer\", \"id\": \"{{def_manufacturer_id}}\"}, \"attributes\": {\"slug\": \"rt-missing-width\", \"model\": \"RT Missing Width\", \"form_factor\": \"4-post\", \"u_height\": \"42\", \"starting_unit\": \"1\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Error mentions missing width', function () {",
                  "    const body = pm.response.json();",
                  "    const msg = Array.isArray(body.message) ? body.message.join('\\n') : String(body.message || '');",
                  "    pm.expect(msg).to.include(\"Missing required attribute 'width'\");",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Entity (rack-type) (201)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"create\", \"entity\": \"rack-type\", \"parent\": {\"entity\": \"manufacturer\", \"id\": \"{{def_manufacturer_id}}\"}, \"attributes\": {\"slug\": \"rt-ok\", \"model\": \"RT OK\", \"form_factor\": \"4-post\", \"width\": \"19\", \"u_height\": \"42\", \"starting_unit\": \"1\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Diagram includes new rack-type mermaid block', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.content).to.include('rack-type');",
                  "    pm.expect(body.content).to.include('rack_type_');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Entity (platform)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"create\", \"entity\": \"platform\", \"parent\": {\"root\": \"definitions\"}, \"attributes\": {\"name\": \"IOS-XE\", \"slug\": \"ios-xe\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Diagram includes new platform', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.content).to.include('platform: IOS-XE');",
                  "    pm.expect(body.content).to.include('platform_');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Entity (tenant-group)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"create\", \"entity\": \"tenant-group\", \"parent\": {\"root\": \"definitions\"}, \"attributes\": {\"name\": \"Customers\", \"slug\": \"customers\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Diagram includes new tenant-group', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.content).to.include('tenant-group: Customers');",
                  "    pm.expect(body.content).to.include('tenant_group_');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Entity (tenant)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"create\", \"entity\": \"tenant\", \"parent\": {\"root\": \"definitions\"}, \"attributes\": {\"name\": \"Example Corp\", \"slug\": \"example-corp\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Diagram includes new tenant', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.content).to.include('tenant: Example Corp');",
                  "    pm.expect(body.content).to.include('tenant_');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Entity (site-group)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"create\", \"entity\": \"site-group\", \"parent\": {\"root\": \"definitions\"}, \"attributes\": {\"name\": \"Campus\", \"slug\": \"campus\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Diagram includes new site-group', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.content).to.include('site-group: Campus');",
                  "    pm.expect(body.content).to.include('site_group_');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Entity (device-type)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"create\", \"entity\": \"device-type\", \"parent\": {\"root\": \"definitions\"}, \"attributes\": {\"slug\": \"c9300\", \"model\": \"Catalyst 9300\", \"u_height\": \"1\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Diagram includes new device-type mermaid block', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.content).to.include('device_type_');",
                  "    pm.expect(body.content).to.include('model: Catalyst 9300');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Entity (virtual-chassis)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"create\", \"entity\": \"virtual-chassis\", \"parent\": {\"root\": \"definitions\"}, \"attributes\": {\"name\": \"VC-1\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Diagram includes new virtual-chassis', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.content).to.include('virtual-chassis: VC-1');",
                  "    pm.expect(body.content).to.include('virtual_chassis_');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Entity (region)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"create\", \"entity\": \"region\", \"parent\": {\"root\": \"infrastructure\"}, \"attributes\": {\"name\": \"Test Region\", \"slug\": \"test-region\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Diagram content is updated with new region', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('id');",
                  "    pm.expect(body).to.have.property('content');",
                  "    pm.expect(body.content).to.include('Test Region');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Entity (region) invalid slug pattern",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"create\", \"entity\": \"region\", \"parent\": {\"root\": \"infrastructure\"}, \"attributes\": {\"name\": \"Bad Region\", \"slug\": \"bad slug\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Error message mentions slug/pattern', function () {",
                  "    const body = pm.response.json();",
                  "    const msg = Array.isArray(body.message) ? body.message.join('\\n') : String(body.message || '');",
                  "    pm.expect(msg).to.include('slug');",
                  "    pm.expect(msg).to.include('pattern');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "List Elements (find region)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"list-elements\", \"entity\": \"region\"}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Finds Test Region and saves entity_id', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('elements');",
                  "    pm.expect(body.elements).to.be.an('array');",
                  "    const region = body.elements.find(e => e.name === 'Test Region');",
                  "    pm.expect(region, 'Test Region should exist').to.not.be.undefined;",
                  "    pm.collectionVariables.set('entity_id', region.id);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Update Entity (region) invalid name maxLength",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"update\", \"entity\": \"region\", \"id\": \"{{entity_id}}\", \"attributes\": {\"name\": \"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Error message mentions maxLength', function () {",
                  "    const body = pm.response.json();",
                  "    const msg = Array.isArray(body.message) ? body.message.join('\\n') : String(body.message || '');",
                  "    pm.expect(msg).to.include('maxLength');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get Element (region)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"get-element\", \"entity\": \"region\", \"id\": \"{{entity_id}}\"}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Element has correct attributes', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('entity', 'region');",
                  "    pm.expect(body).to.have.property('id', pm.collectionVariables.get('entity_id'));",
                  "    pm.expect(body).to.have.property('attributes');",
                  "    pm.expect(body.attributes).to.have.property('name', 'Test Region');",
                  "    pm.expect(body).to.have.property('parent');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Update Entity (region)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"update\", \"entity\": \"region\", \"id\": \"{{entity_id}}\", \"attributes\": {\"name\": \"Updated Region\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Diagram reflects updated region name', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.content).to.include('Updated Region');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Child Entity (site) invalid status enum",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"create\", \"entity\": \"site\", \"parent\": {\"entity\": \"region\", \"id\": \"{{entity_id}}\"}, \"attributes\": {\"name\": \"Bad Site\", \"slug\": \"bad-site\", \"status\": \"Active\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Error message mentions allowed values', function () {",
                  "    const body = pm.response.json();",
                  "    const msg = Array.isArray(body.message) ? body.message.join('\\n') : String(body.message || '');",
                  "    pm.expect(msg).to.include('status');",
                  "    pm.expect(msg).to.include('must be one of');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Child Entity (site)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"create\", \"entity\": \"site\", \"parent\": {\"entity\": \"region\", \"id\": \"{{entity_id}}\"}, \"attributes\": {\"name\": \"Test Site\", \"slug\": \"test-site\", \"status\": \"active\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Diagram includes new site', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.content).to.include('Test Site');",
                  "});",
                  "",
                  "pm.test('Extracts child_entity_id from content', function () {",
                  "    const body = pm.response.json();",
                  "    const match = body.content.match(/site_([a-f0-9]+)/);",
                  "    pm.expect(match, 'Site ID pattern should be in content').to.not.be.null;",
                  "    pm.collectionVariables.set('child_entity_id', match[1]);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Update Entity (site) invalid latitude maximum",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"update\", \"entity\": \"site\", \"id\": \"{{child_entity_id}}\", \"attributes\": {\"latitude\": \"91.000000\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Error message mentions maximum', function () {",
                  "    const body = pm.response.json();",
                  "    const msg = Array.isArray(body.message) ? body.message.join('\\n') : String(body.message || '');",
                  "    pm.expect(msg).to.include('latitude');",
                  "    pm.expect(msg).to.include('<=');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Update Entity (site) valid latitude format",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"update\", \"entity\": \"site\", \"id\": \"{{child_entity_id}}\", \"attributes\": {\"latitude\": \"02.123456\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "List Elements (find site via location parents)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"list-elements\", \"entity\": \"location\"}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Finds Test Site in location parents', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('elements');",
                  "    const site = body.elements.find(e => e.name === 'Test Site' && e.entity === 'site');",
                  "    pm.expect(site, 'Test Site should be a valid parent for location').to.not.be.undefined;",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Move Entity (site to root)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"move\", \"entity\": \"site\", \"id\": \"{{child_entity_id}}\", \"parent\": {\"root\": \"infrastructure\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Diagram updated after move', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('content');",
                  "    pm.expect(body.content).to.include('Test Site');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Delete Child Entity (site)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"delete\", \"entity\": \"site\", \"id\": \"{{child_entity_id}}\"}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Site removed from diagram', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.content).to.not.include('Test Site');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Delete Parent Entity (region)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"delete\", \"entity\": \"region\", \"id\": \"{{entity_id}}\"}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Region removed from diagram', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.content).to.not.include('Updated Region');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Invalid Command (400)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"invalid-cmd\", \"entity\": \"region\"}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 400 for invalid command', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Error response has expected shape', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('statusCode', 400);",
                  "    pm.expect(body).to.have.property('message');",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "CSV Export",
      "description": "CSV generation and download endpoints (uses diagram from Commands section)",
      "item": [
        {
          "name": "Setup: Create Region for CSV",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"command\": \"create\", \"entity\": \"region\", \"parent\": {\"root\": \"infrastructure\"}, \"attributes\": {\"name\": \"CSV Export Region\", \"slug\": \"csv-export-region\"}}"
            },
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}/commands",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}", "commands"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Region created for CSV tests', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.content).to.include('CSV Export Region');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "List CSV Types (Infrastructure)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{backend_base_url}}/api/csv/{{diagram_id}}?category=Infrastructure",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "csv", "{{diagram_id}}"],
              "query": [{ "key": "category", "value": "Infrastructure" }]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has CSV types for Infrastructure', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('diagramId');",
                  "    pm.expect(body).to.have.property('category', 'Infrastructure');",
                  "    pm.expect(body).to.have.property('types');",
                  "    pm.expect(body.types).to.be.an('array');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "List CSV Types (Definitions)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{backend_base_url}}/api/csv/{{diagram_id}}?category=Definitions",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "csv", "{{diagram_id}}"],
              "query": [{ "key": "category", "value": "Definitions" }]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has CSV types for Definitions', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('category', 'Definitions');",
                  "    pm.expect(body).to.have.property('types');",
                  "    pm.expect(body.types).to.be.an('array');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "List CSV Types - Invalid Category (400)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{backend_base_url}}/api/csv/{{diagram_id}}?category=Invalid",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "csv", "{{diagram_id}}"],
              "query": [{ "key": "category", "value": "Invalid" }]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 400 for invalid category', function () {",
                  "    pm.response.to.have.status(400);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Download CSV by Type",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{backend_base_url}}/api/csv/{{diagram_id}}?type=region",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "csv", "{{diagram_id}}"],
              "query": [{ "key": "type", "value": "region" }]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response is CSV content', function () {",
                  "    pm.expect(pm.response.headers.get('Content-Type')).to.include('text/csv');",
                  "    pm.expect(pm.response.headers.get('Content-Disposition')).to.include('attachment');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Download CSV ZIP",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{backend_base_url}}/api/csv/{{diagram_id}}/zip",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "csv", "{{diagram_id}}", "zip"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response is ZIP archive', function () {",
                  "    pm.expect(pm.response.headers.get('Content-Type')).to.include('application/zip');",
                  "    pm.expect(pm.response.headers.get('Content-Disposition')).to.include('attachment');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "CSV for Non-Existent Diagram (404)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{backend_base_url}}/api/csv/aaaaaaaaaaaaaaaa?category=Infrastructure",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "csv", "aaaaaaaaaaaaaaaa"],
              "query": [{ "key": "category", "value": "Infrastructure" }]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 404 for non-existent diagram', function () {",
                  "    pm.response.to.have.status(404);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Cleanup",
      "description": "Remove test data created during the test run",
      "item": [
        {
          "name": "Delete Test Diagram",
          "request": {
            "method": "DELETE",
            "header": [],
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Deleted diagram ID matches', function () {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('id', pm.collectionVariables.get('diagram_id'));",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Verify Diagram Deleted (404)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{backend_base_url}}/api/diagrams/{{diagram_id}}",
              "host": ["{{backend_base_url}}"],
              "path": ["api", "diagrams", "{{diagram_id}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Diagram no longer exists', function () {",
                  "    pm.response.to.have.status(404);",
                  "});",
                  "",
                  "// Clean up collection variables after verification",
                  "pm.collectionVariables.set('diagram_id', '');",
                  "pm.collectionVariables.set('entity_id', '');",
                  "pm.collectionVariables.set('child_entity_id', '');",
                  "pm.collectionVariables.set('def_manufacturer_id', '');",
                  "pm.collectionVariables.set('def_device_role_id', '');"
                ]
              }
            }
          ]
        }
      ]
    }
  ]
}
